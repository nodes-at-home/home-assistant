###
### 22.08.2019 split up
###

  - alias: indoor_lights_on_at_coming_home_or_sunset
    trigger:
      - platform: state
        entity_id: group.family_devices
        to: 'home'
      - platform: sun
        event: sunset
        offset: "00:00:00"
    condition:
      - condition: sun
        after: sunset
        after_offset: "00:00:00"
      - condition: time
        before: input_datetime.sleep
      - condition: or
        conditions:
          - condition: state
            entity_id: group.family_devices
            state: 'home'
          - condition: state
            entity_id: input_boolean.light_simulation
            state: 'on'
    action:
      - service: homeassistant.turn_on
        entity_id: 
            - light.automatic_indoor_lights
            - light.sonoff_kitchen_led # is not in group light.automatic_inddor_lights

  - alias: indoor_lights_by_night_on_at_coming_home
    trigger:
      - platform: state
        entity_id: group.family_devices
        to: 'home'
    condition:
      - condition: sun
        after: sunset
        after_offset: "00:00:00"
      - condition: time
        after: input_datetime.sleep
        before: input_datetime.nightlight_end
      - condition: state
        entity_id: group.family_devices
        state: 'home'
    action:
      - service: homeassistant.turn_on
        entity_id: 
            - light.automatic_indoor_lights_by_night
      - delay: input_number.nightlight_duration
      - service: homeassistant.turn_off
        entity_id: 
            - light.automatic_indoor_lights_by_night

  - alias: indoor_lights_off_at_getting_out_or_sunrise
    trigger:
      - platform: state
        entity_id: group.family_devices
        to: 'not_home'
      - platform: sun
        event: sunrise
        offset: "+00:00:00"
    action:
      - service: scene.turn_on
        entity_id: scene.kitchen_background_light
      - service: homeassistant.turn_off
        entity_id: 
            - light.automatic_indoor_lights
            - light.automatic_indoor_lights_delayed_switched
            - light.automatic_indoor_lights_immediatly_switched_off_extra

  - alias: indoor_lights_off_when_tv_switched_off
    trigger:
        platform: state
        entity_id: media_player.sony_bravia_tv
        from: "on"
        to: "off"
        for:
            minutes: 1
    condition:
      - condition: time
        after: input_datetime.tv_off_period_start
        before: input_datetime.tv_off_period_end
    action:
      - delay:
            minutes: "{{ states ( 'input_number.tvoff_lightsoff_delay1' ) | int - 1 }}"
      - service: scene.turn_on
        entity_id: scene.kitchen_background_light
      - service: homeassistant.turn_off
        entity_id: 
            - light.automatic_indoor_lights_immediatly_switched
            - light.automatic_indoor_lights_immediatly_switched_off_extra
      - delay:
            minutes: "{{ ( states ( 'input_number.tvoff_lightsoff_delay2' ) | int - states ( 'input_number.tvoff_lightsoff_delay1' ) | int ) }}"
      - service: homeassistant.turn_off
        entity_id: 
            - light.automatic_indoor_lights_delayed_switched

  - alias: indoor_lights_off_after_random_delay
    trigger:
      - platform: time
        at: input_datetime.sleep
    condition:
      - condition: state
        entity_id: input_boolean.light_simulation
        state: 'on'
    action:
      # switch off between 22:00 amd 24:00
      - delay:
            minutes: "{{ range ( 0,  states ( 'input_number.max_random_off_duration' ) | int ) | random | int }}"
      - service: scene.turn_on
        entity_id: scene.kitchen_background_light
      - service: homeassistant.turn_off
        entity_id: 
            - light.automatic_indoor_lights_immediatly_switched
            - light.automatic_indoor_lights_delayed_switched
            - light.automatic_indoor_lights_immediatly_switched_off_extra

  - alias: indoor_lights_simulation_off_at_coming_home
    trigger:
      - platform: state
        entity_id: group.family_devices
        to: 'home'
    condition:
      - condition: state
        entity_id: input_boolean.light_simulation
        state: 'on'
    action:
      - service: input_boolean.turn_off
        entity_id: input_boolean.light_simulation

  - alias: indoor_roof_light
    trigger:
      - platform: state
        entity_id: binary_sensor.dachboden
    action:
      - service: switch.turn_{{ trigger.to_state.state }}
        entity_id: switch.shelly_roof_socket
