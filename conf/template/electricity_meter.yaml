###
### 31.03.2023
###

  - trigger:
      - platform: state
        entity_id: sensor.tasmota_lk13be_power
    sensor:
      - name: electricity_meter_power
        unit_of_measurement: W
        state: >
            {% set val = states ( 'sensor.tasmota_lk13be_power' ) | float %}
            {% set lastval = state_attr ( 'sensor.electricity_meter_power', 'lastvalue' ) %}
            {% set max = states ( 'input_number.electricity_meter_threshold_power' ) | float %}
            {% if lastval %}
                {% if val == 0 or val > max or val < -max %}
                    {{ lastval }}
                {% else %}
                    {{ val }}
                {% endif %}
            {% else %}
                {{ val }}
            {% endif %}
        attributes:
            lastvalue: >
                {% set val = states ( 'sensor.tasmota_lk13be_power' ) | float %}
                {% set lastval = state_attr ( 'sensor.electricity_meter_power', 'lastvalue' ) %}
                {% set max = states ( 'input_number.electricity_meter_threshold_power' ) | float %}
                {% if lastval %}
                {% if val == 0 or val > max or val < -max %}
                        {{ lastval }}
                    {% else %}
                        {{ val }}
                    {% endif %}
                {% else %}
                    {{ val }}
                {% endif %}

  - trigger:
      - platform: state
        entity_id: sensor.tasmota_lk13be_energy_total_in
    sensor:
      - name: electricity_meter_in
        unit_of_measurement: kWh
        state: >
            {% set val = states ( 'sensor.tasmota_lk13be_energy_total_in' ) | float %}
            {% set lastval = state_attr ( 'sensor.electricity_meter_in', 'lastvalue' ) %}
            {% if lastval %}
                {% if val < lastval %}
                    {{ lastval }}
                {% elif val > lastval + 1 %}
                    {{ lastval }}
                {% else %}
                    {{ val }}
                {% endif %}
            {% else %}
                {{ val }}
            {% endif %}
        attributes:
            lastvalue: >
                {% set val = states ( 'sensor.tasmota_lk13be_energy_total_in' ) | float %}
                {% set lastval = state_attr ( 'sensor.electricity_meter_in', 'lastvalue' ) %}
                {% if lastval %}
                    {% if val < lastval %}
                        {{ lastval }}
                    {% elif val > lastval + 1 %}
                        {{ lastval }}
                    {% else %}
                        {{ val }}
                    {% endif %}
                {% else %}
                    {{ val }}
                {% endif %}

  - trigger:
      - platform: state
        entity_id: sensor.tasmota_lk13be_energy_total_out
    sensor:
      - name: electricity_meter_out
        unit_of_measurement: kWh
        state: >
            {% set val = states ( 'sensor.tasmota_lk13be_energy_total_out' ) | float %}
            {% set lastval = state_attr ( 'sensor.electricity_meter_out', 'lastvalue' ) %}
            {% if lastval %}
                {% if val < lastval %}
                    {{ lastval }}
                {% elif val > lastval + 1 %}
                    {{ lastval }}
                {% else %}
                    {{ val }}
                {% endif %}
            {% else %}
                {{ val }}
            {% endif %}
        attributes:
            lastvalue: >
                {% set val = states ( 'sensor.tasmota_lk13be_energy_total_out' ) | float %}
                {% set lastval = state_attr ( 'sensor.electricity_meter_out', 'lastvalue' ) %}
                {% if lastval %}
                    {% if val < lastval %}
                        {{ lastval }}
                    {% elif val > lastval + 1 %}
                        {{ lastval }}
                    {% else %}
                        {{ val }}
                    {% endif %}
                {% else %}
                    {{ val }}
                {% endif %}

  - trigger:
      - platform: state
        entity_id: sensor.electricity_meter_quarterhourly_in
        attribute: last_reset
    sensor:
      - name: electricity_quarterhourly_in
        unit_of_measurement: kWh
        state: "{{ state_attr ( 'sensor.electricity_meter_quarterhourly_in', 'last_period' ) }}"
        attributes:
            last_reset: '{{ state_attr ( "sensor.electricity_meter_quarterhourly_in", "last_reset" ) }}'

  - trigger:
      - platform: state
        entity_id: sensor.electricity_meter_quarterhourly_out
        attribute: last_reset
    sensor:
      - name: electricity_quarterhourly_out
        unit_of_measurement: kWh
        state: "{{ state_attr ( 'sensor.electricity_meter_quarterhourly_out', 'last_period' ) }}"
        attributes:
            last_reset: '{{ state_attr ( "sensor.electricity_meter_quarterhourly_out", "last_reset" ) }}'
